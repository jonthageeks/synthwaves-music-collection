<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Immersive synthwave music experience with audio-reactive 3D visuals">
  <meta name="theme-color" content="#10002b">
  <title>SynthWaves · Audio-Reactive Experience</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* Color Palette */
      --color-bg-deep: #10002b;
      --color-bg-rich: #240046;
      --color-bg-dark: #0a0014;
      --color-text-primary: #ffffff;
      --color-text-secondary: #e0aaff;
      --color-accent-cyan: #00f3ff;
      --color-accent-pink: #ff0099;
      --color-accent-purple: #9d4edd;
      
      /* Spacing */
      --space-xs: 0.5rem;
      --space-sm: 1rem;
      --space-md: 1.5rem;
      --space-lg: 2rem;
      --space-xl: 3rem;
      --space-2xl: 5rem;
      
      /* Typography */
      --font-display: "Orbitron", sans-serif;
      --font-body: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 2rem;
      --font-size-4xl: 3rem;
      
      /* Effects */
      --glass-bg: rgba(16, 0, 43, 0.6);
      --glass-border: rgba(224, 170, 255, 0.15);
      --shadow-glow-cyan: 0 0 20px rgba(0, 243, 255, 0.3);
      --shadow-glow-pink: 0 0 20px rgba(255, 0, 153, 0.3);
      
      /* Animation */
      --transition-fast: 150ms;
      --transition-base: 300ms;
      --transition-slow: 600ms;
      --ease-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
      
      /* 3D Scrolling */
      --section-gap: 800px;
    }

    /* Reset & Base */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: auto;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      min-height: 100vh;
      color: var(--color-text-secondary);
      background: linear-gradient(180deg, var(--color-bg-deep), var(--color-bg-rich));
      font-family: var(--font-body);
      font-size: var(--font-size-base);
      line-height: 1.6;
      overflow-x: hidden;
      transform-style: preserve-3d;
    }

    /* CRT Scanline Effect */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.1) 0px,
        transparent 1px,
        transparent 2px,
        rgba(0, 0, 0, 0.1) 3px
      );
      opacity: 0.03;
    }

    /* Focus Styles */
    *:focus-visible {
      outline: 2px solid var(--color-accent-cyan);
      outline-offset: 2px;
    }

    /* Skip Link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--color-accent-cyan);
      color: var(--color-bg-deep);
      padding: var(--space-sm) var(--space-md);
      text-decoration: none;
      z-index: 100;
      font-weight: 600;
      font-family: var(--font-display);
    }
    .skip-link:focus {
      top: 0;
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* WebGL Canvas */
    #bg {
      position: fixed;
      inset: 0;
      z-index: -1;
      width: 100%;
      height: 100%;
      display: block;
      pointer-events: none;
    }

    /* Header & Navigation */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      backdrop-filter: blur(16px) saturate(120%);
      background: var(--glass-bg);
      border-bottom: 1px solid var(--color-accent-pink);
      box-shadow: var(--shadow-glow-pink);
    }

    .nav-container {
      perspective: 1200px;
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-sm) var(--space-md);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-md);
    }

    .brand {
      font-family: var(--font-display);
      font-weight: 900;
      font-size: var(--font-size-2xl);
      letter-spacing: 2px;
      transform: translateZ(20px);
      background: linear-gradient(135deg, var(--color-accent-cyan), var(--color-accent-pink));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 0 8px var(--color-accent-cyan));
      text-transform: uppercase;
    }

    .nav-list {
      list-style: none;
      display: flex;
      align-items: center;
      gap: var(--space-md);
      transform-style: preserve-3d;
    }

    .nav-link {
      position: relative;
      display: inline-block;
      padding: var(--space-xs) var(--space-sm);
      border-radius: 4px;
      color: var(--color-text-primary);
      text-decoration: none;
      font-weight: 600;
      font-family: var(--font-display);
      letter-spacing: 1px;
      font-size: var(--font-size-sm);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      transform: translateZ(0);
      transition: all var(--transition-base) var(--ease-bounce);
      text-transform: uppercase;
    }

    .nav-link:hover,
    .nav-link:focus-visible {
      transform: translateZ(24px) scale(1.05);
      background: var(--color-accent-cyan);
      color: var(--color-bg-deep);
      border-color: var(--color-accent-cyan);
      box-shadow: var(--shadow-glow-cyan);
    }

    /* Main Content Structure */
    .main-content {
      transform-style: preserve-3d;
      position: relative;
    }

    .panel {
      min-height: 100svh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(3rem, 15vh, 7.5rem) var(--space-md);
      position: relative;
      will-change: transform;
    }

    .panel > * {
      pointer-events: auto;
    }

    /* Remove 3D transforms - simplified scroll */
    #home { }
    #about { }
    #carousel-section { }
    #visualizer { }
    #shows { }

    /* Content Wrapper */
    .content-wrap {
      max-width: 1200px;
      width: 100%;
      position: relative;
      z-index: 2;
    }

    /* Typography */
    .display {
      font-family: var(--font-display);
      font-weight: 900;
      font-size: clamp(3rem, 10vw, 7rem);
      line-height: 0.95;
      margin-bottom: var(--space-md);
      letter-spacing: -2px;
      color: var(--color-text-primary);
      text-shadow: 
        0 0 10px var(--color-accent-pink),
        0 0 30px var(--color-accent-pink),
        0 0 60px var(--color-accent-pink);
      text-transform: uppercase;
      will-change: transform;
    }

    .lead {
      font-size: clamp(1.1rem, 2.5vw, 1.5rem);
      opacity: 0.9;
      max-width: 600px;
      margin: 0 auto var(--space-xl);
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
      will-change: transform;
    }

    .section-title {
      font-family: var(--font-display);
      font-size: clamp(2rem, 5vw, 3.5rem);
      margin-bottom: var(--space-xl);
      color: var(--color-accent-cyan);
      text-transform: uppercase;
      border-left: 5px solid var(--color-accent-pink);
      padding-left: var(--space-md);
      background: linear-gradient(90deg, rgba(255, 0, 153, 0.1), transparent);
      will-change: transform;
    }

    /* Buttons */
    .cta {
      display: flex;
      gap: var(--space-md);
      flex-wrap: wrap;
      justify-content: center;
      margin-top: var(--space-md);
    }

    .btn {
      appearance: none;
      border: 1px solid var(--color-accent-cyan);
      background: rgba(0, 243, 255, 0.1);
      color: var(--color-accent-cyan);
      padding: 0.875rem var(--space-xl);
      border-radius: 2px;
      cursor: pointer;
      font-family: var(--font-display);
      font-weight: 700;
      font-size: var(--font-size-base);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      transition: all var(--transition-base) var(--ease-smooth);
      position: relative;
      overflow: hidden;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: var(--color-accent-cyan);
      transform: translate(-50%, -50%);
      transition: width var(--transition-slow), height var(--transition-slow);
      z-index: -1;
    }

    .btn:hover::before,
    .btn:focus-visible::before {
      width: 300px;
      height: 300px;
    }

    .btn:hover,
    .btn:focus-visible {
      color: var(--color-bg-deep);
      box-shadow: var(--shadow-glow-cyan);
      transform: translateY(-3px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      border-color: var(--color-accent-pink);
      color: var(--color-accent-pink);
      background: rgba(255, 0, 153, 0.1);
    }

    .btn-secondary::before {
      background: var(--color-accent-pink);
    }

    /* Hero Section */
    .hero {
      text-align: center;
      align-content: center;
      position: relative;
    }

    /* 3D Carousel Styles */
    .carousel-wrapper {
      position: relative;
      width: 100%;
      height: 500px;
      perspective: 1200px;
      margin: var(--space-2xl) 0;
    }

    .carousel-container {
      position: relative;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform 1s var(--ease-smooth);
    }

    .carousel-item {
      position: absolute;
      width: 320px;
      height: 400px;
      left: 50%;
      top: 50%;
      transform-style: preserve-3d;
      backface-visibility: hidden;
      cursor: pointer;
      transition: all var(--transition-slow) var(--ease-smooth);
    }

    .carousel-card {
      width: 100%;
      height: 100%;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: var(--space-md);
      backdrop-filter: blur(12px);
      display: flex;
      flex-direction: column;
      transition: all var(--transition-base);
    }

    .carousel-item:hover .carousel-card {
      border-color: var(--color-accent-pink);
      box-shadow: 0 10px 40px rgba(255, 0, 153, 0.3);
      transform: translateZ(20px);
    }

    .carousel-img-wrap {
      width: 100%;
      height: 240px;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: var(--space-sm);
    }

    .carousel-img-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: grayscale(0.4) contrast(1.2);
      transition: filter var(--transition-base);
    }

    .carousel-item:hover .carousel-img-wrap img {
      filter: grayscale(0) contrast(1);
    }

    .carousel-card h3 {
      font-family: var(--font-display);
      color: var(--color-text-primary);
      margin-bottom: var(--space-xs);
      font-size: var(--font-size-xl);
    }

    .carousel-card p {
      font-size: var(--font-size-sm);
      color: #aaa;
      margin-bottom: var(--space-sm);
      flex-grow: 1;
    }

    .carousel-controls {
      display: flex;
      justify-content: center;
      gap: var(--space-md);
      margin-top: var(--space-xl);
    }

    .carousel-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid var(--color-accent-cyan);
      background: rgba(0, 243, 255, 0.1);
      color: var(--color-accent-cyan);
      font-size: var(--font-size-2xl);
      cursor: pointer;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .carousel-btn:hover,
    .carousel-btn:focus-visible {
      background: var(--color-accent-cyan);
      color: var(--color-bg-deep);
      box-shadow: var(--shadow-glow-cyan);
      transform: scale(1.1);
    }

    /* Audio Visualizer */
    .audio-viz {
      display: grid;
      gap: var(--space-md);
      background: rgba(0, 0, 0, 0.3);
      padding: var(--space-xl);
      border: 1px solid var(--color-accent-cyan);
      border-radius: 12px;
      box-shadow: inset 0 0 50px rgba(0, 243, 255, 0.1);
    }

    .viz-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-sm);
    }

    audio {
      width: 100%;
      height: 54px;
      border-radius: 8px;
      filter: invert(1) hue-rotate(180deg);
    }

    #viz {
      width: 100%;
      height: 240px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 8px;
      border-bottom: 2px solid var(--color-accent-pink);
    }

    /* Tour Dates */
    .tour-list {
      list-style: none;
      padding: 0;
      font-size: var(--font-size-lg);
    }

    .tour-item {
      padding: var(--space-md) 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all var(--transition-base);
    }

    .tour-item:hover {
      padding-left: var(--space-sm);
      border-color: var(--color-accent-cyan);
    }

    .tour-date {
      font-family: var(--font-display);
      font-weight: 700;
      color: var(--color-text-primary);
    }

    .tour-venue {
      color: var(--color-accent-cyan);
      font-weight: 600;
    }

    /* Footer */
    .footer {
      padding: var(--space-2xl) var(--space-md);
      text-align: center;
      opacity: 0.8;
      border-top: 1px solid var(--color-accent-cyan);
      background: var(--color-bg-dark);
      font-family: var(--font-display);
      font-size: var(--font-size-sm);
    }

    /* Utility Classes */
    .text-center {
      text-align: center;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .nav-container {
        flex-direction: column;
        gap: var(--space-sm);
      }

      .nav-list {
        gap: var(--space-sm);
        flex-wrap: wrap;
        justify-content: center;
      }

      .nav-link {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
      }

      .carousel-wrapper {
        height: 450px;
      }

      .carousel-item {
        width: 280px;
        height: 360px;
      }

      .cta {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Skip Link -->
  <a href="#main" class="skip-link">Skip to main content</a>

  <!-- WebGL Background -->
  <canvas id="bg" aria-hidden="true"></canvas>

  <!-- Header -->
  <header class="header" role="banner">
    <nav class="nav-container" aria-label="Primary navigation">
      <div class="brand" aria-label="SynthWaves">SynthWaves</div>
      <ul class="nav-list" id="navList" role="list">
        <li><a href="#home" class="nav-link">Home</a></li>
        <li><a href="#about" class="nav-link">About</a></li>
        <li><a href="#carousel-section" class="nav-link">Music</a></li>
        <li><a href="#visualizer" class="nav-link">Visualizer</a></li>
        <li><a href="#shows" class="nav-link">Shows</a></li>
      </ul>
    </nav>
  </header>

  <!-- Main Content -->
  <main id="main" class="main-content">
    
    <!-- Hero Section -->
    <section id="home" class="panel hero" aria-labelledby="hero-title">
      <div class="content-wrap">
        <div data-gsap-depth="0.2">
          <h1 id="hero-title" class="display">SynthWaves</h1>
          <p class="lead">Experience the sound of the future retro.<br>Immersive audio-reactive visuals.</p>
          <div class="cta">
            <a href="#visualizer" class="btn">Launch Visualizer</a>
            <a href="#carousel-section" class="btn btn-secondary">Explore Music</a>
          </div>
        </div>
      </div>
    </section>

    <!-- About Section -->
    <section id="about" class="panel" aria-labelledby="about-title">
      <div class="content-wrap">
        <div data-gsap-depth="0.15">
          <h2 id="about-title" class="section-title">The Grid</h2>
          <p style="font-size: var(--font-size-lg); max-width: 700px;">
            We build soundscapes for the digital frontier. Our beats drive the simulation. 
            Every track is engineered to react with the 3D environment, creating a unique 
            audio-visual experience.
          </p>
        </div>
      </div>
    </section>

    <!-- 3D Carousel Section -->
    <section id="carousel-section" class="panel" style="align-items: flex-start;" aria-labelledby="carousel-title">
      <div class="content-wrap">
        <h2 id="carousel-title" class="section-title" data-gsap-depth="0.1">Discography</h2>
        
        <div class="carousel-wrapper" data-gsap-depth="0.2">
          <div class="carousel-container" id="carousel">
            <!-- Carousel items will be generated by JavaScript -->
          </div>
        </div>

        <div class="carousel-controls">
          <button class="carousel-btn" id="prevBtn" aria-label="Previous track">‹</button>
          <button class="carousel-btn" id="nextBtn" aria-label="Next track">›</button>
        </div>

        <div style="text-align: center; margin-top: var(--space-xl);">
          <button class="btn" id="addMusicBtn">+ Add New Track</button>
        </div>
      </div>
    </section>

    <!-- Visualizer Section -->
    <section id="visualizer" class="panel" aria-labelledby="viz-title">
      <div class="content-wrap">
        <h2 id="viz-title" class="section-title" data-gsap-depth="0.1">System Core</h2>
        <div class="audio-viz" data-gsap-depth="0.15">
          <div class="viz-controls">
            <span>Audio Source</span>
            <button id="micBtn" class="btn" style="padding: 0.5rem var(--space-md); font-size: var(--font-size-sm);">
              Activate Microphone
            </button>
          </div>
          <audio 
            id="audio" 
            controls 
            crossorigin="anonymous" 
            src="https://cdn.pixabay.com/download/audio/2021/09/07/audio_5a3b1b2d40.mp3"
            aria-label="Audio player">
          </audio>
          <canvas id="viz" width="1024" height="240" aria-label="Audio frequency visualizer"></canvas>
        </div>
      </div>
    </section>

    <!-- Shows Section -->
    <section id="shows" class="panel" aria-labelledby="shows-title">
      <div class="content-wrap">
        <h2 id="shows-title" class="section-title" data-gsap-depth="0.1">Tour Dates</h2>
        <ul class="tour-list" data-gsap-depth="0.15" role="list">
          <li class="tour-item">
            <span class="tour-date">DEC 12</span>
            <span class="tour-venue">NEON HALL</span>
          </li>
          <li class="tour-item">
            <span class="tour-date">JAN 04</span>
            <span class="tour-venue">ECHO DOME</span>
          </li>
          <li class="tour-item">
            <span class="tour-date">FEB 10</span>
            <span class="tour-venue">NIGHT PLAZA</span>
          </li>
        </ul>
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer class="footer" role="contentinfo">
    <small>&copy; <span id="year"></span> SynthWaves. Powered by Audio-Reactive Three.js.</small>
  </footer>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollToPlugin.min.js"></script>

  <script>
    (function() {
      'use strict';

      // Wait for libraries to load
      function waitForLibraries() {
        return new Promise((resolve) => {
          const checkLibraries = () => {
            if (typeof THREE !== 'undefined' && typeof gsap !== 'undefined') {
              resolve();
            } else {
              setTimeout(checkLibraries, 50);
            }
          };
          checkLibraries();
        });
      }

    // Configuration
    const CONFIG = {
      sectionGap: 800,
      scrollMultiplier: 1.5,
      carouselRadius: 600,
      musicStorageKey: 'synthwaves:music-library'
    };

    // Default Music Data
    const DEFAULT_MUSIC = [
      {
        id: 1,
        title: 'Neon Nights',
        artist: 'SynthWaves',
        genre: 'Synthwave',
        duration: '42 min',
        image: 'https://picsum.photos/seed/synth1/640/480',
        audio: 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8c8a73467.mp3'
      },
      {
        id: 2,
        title: 'Cyber City',
        artist: 'SynthWaves',
        genre: 'Darksynth',
        duration: '38 min',
        image: 'https://picsum.photos/seed/synth2/640/480',
        audio: 'https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3'
      },
      {
        id: 3,
        title: 'Mainframe',
        artist: 'SynthWaves',
        genre: 'Retrowave',
        duration: '45 min',
        image: 'https://picsum.photos/seed/synth3/640/480',
        audio: 'https://cdn.pixabay.com/download/audio/2021/11/23/audio_035a336ce6.mp3'
      },
      {
        id: 4,
        title: 'Digital Dreams',
        artist: 'SynthWaves',
        genre: 'Chillwave',
        duration: '36 min',
        image: 'https://picsum.photos/seed/synth4/640/480',
        audio: 'https://cdn.pixabay.com/download/audio/2021/09/07/audio_5a3b1b2d40.mp3'
      }
    ];

    // Utilities
    const utils = {
      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func(...args), wait);
        };
      },

      throttle(func, limit) {
        let inThrottle;
        return function(...args) {
          if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        };
      }
    };

    // Audio System Module
    const audioSystem = (() => {
      const state = {
        analyser: null,
        dataArray: null,
        hasInit: false,
        ctx: null,
        currentSource: null
      };

      const audioElement = document.getElementById('audio');
      const micBtn = document.getElementById('micBtn');

      async function init(isMic = false) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        
        if (!state.ctx) {
          state.ctx = new AudioContext();
        }
        
        if (state.ctx.state === 'suspended') {
          await state.ctx.resume();
        }

        if (state.hasInit && !isMic) return;

        try {
          if (isMic) {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const micSource = state.ctx.createMediaStreamSource(stream);
            const analyser = state.ctx.createAnalyser();
            analyser.fftSize = 256;
            
            micSource.connect(analyser);
            
            state.analyser = analyser;
            state.dataArray = new Uint8Array(analyser.frequencyBinCount);
            state.hasInit = true;
            
            audioElement.pause();
            micBtn.textContent = "LISTENING...";
            micBtn.style.background = "var(--color-accent-pink)";
            micBtn.style.color = "white";
            
            return;
          }

          if (!state.analyser) {
            const source = state.ctx.createMediaElementSource(audioElement);
            const analyser = state.ctx.createAnalyser();
            analyser.fftSize = 256;
            
            source.connect(analyser);
            analyser.connect(state.ctx.destination);
            
            state.analyser = analyser;
            state.dataArray = new Uint8Array(analyser.frequencyBinCount);
            state.hasInit = true;
          }
          
        } catch (error) {
          console.error("Audio Context Init Failed:", error);
          if (isMic) alert("Microphone access denied. Check permissions.");
        }
      }

      function setupEventListeners() {
        document.body.addEventListener('click', () => init(false), { once: true });
        audioElement.addEventListener('play', () => init(false));
        micBtn.addEventListener('click', () => init(true));
      }

      function playTrack(audioUrl) {
        init(false);
        audioElement.src = audioUrl;
        audioElement.play();
        
        micBtn.textContent = "ACTIVATE MICROPHONE";
        micBtn.style.background = "";
        micBtn.style.color = "";
      }

      return { init, setupEventListeners, playTrack, state };
    })();

    // 3D Carousel Module
    const carousel3D = (() => {
      let currentAngle = 0;
      let musicLibrary = [];
      const container = document.getElementById('carousel');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const addBtn = document.getElementById('addMusicBtn');

      function loadMusic() {
        try {
          const stored = localStorage.getItem(CONFIG.musicStorageKey);
          musicLibrary = stored ? JSON.parse(stored) : [...DEFAULT_MUSIC];
        } catch (error) {
          console.error('Error loading music library:', error);
          musicLibrary = [...DEFAULT_MUSIC];
        }
      }

      function saveMusic() {
        try {
          localStorage.setItem(CONFIG.musicStorageKey, JSON.stringify(musicLibrary));
        } catch (error) {
          console.error('Error saving music library:', error);
        }
      }

      function render() {
        if (!container) return;
        
        container.innerHTML = '';
        const angleStep = 360 / musicLibrary.length;

        musicLibrary.forEach((track, index) => {
          const item = document.createElement('div');
          item.className = 'carousel-item';
          item.setAttribute('role', 'article');
          item.setAttribute('aria-label', `${track.title} by ${track.artist}`);
          
          const angle = angleStep * index;
          const x = Math.sin((angle * Math.PI) / 180) * CONFIG.carouselRadius;
          const z = Math.cos((angle * Math.PI) / 180) * CONFIG.carouselRadius;
          
          item.style.transform = `translate(-50%, -50%) translate3d(${x}px, 0, ${z}px) rotateY(${-angle}deg)`;
          
          item.innerHTML = `
            <div class="carousel-card">
              <div class="carousel-img-wrap">
                <img src="${track.image}" alt="${track.title} album art" loading="lazy" width="320" height="240">
              </div>
              <h3>${track.title}</h3>
              <p>${track.genre} • ${track.duration}</p>
              <button class="btn play-carousel-track" data-audio="${track.audio}" aria-label="Play ${track.title}">
                Play
              </button>
            </div>
          `;
          
          container.appendChild(item);
        });

        updateCarousel();
      }

      function updateCarousel() {
        container.style.transform = `translateZ(-${CONFIG.carouselRadius}px) rotateY(${currentAngle}deg)`;
      }

      function rotate(direction) {
        const angleStep = 360 / musicLibrary.length;
        currentAngle += angleStep * direction;
        updateCarousel();
      }

      function addNewTrack() {
        const newId = Math.max(...musicLibrary.map(t => t.id), 0) + 1;
        const newTrack = {
          id: newId,
          title: `New Track ${newId}`,
          artist: 'SynthWaves',
          genre: 'Synthwave',
          duration: '40 min',
          image: `https://picsum.photos/seed/synth${newId}/640/480`,
          audio: 'https://cdn.pixabay.com/download/audio/2021/09/07/audio_5a3b1b2d40.mp3'
        };
        
        musicLibrary.push(newTrack);
        saveMusic();
        render();
      }

      function setupEventListeners() {
        if (prevBtn) prevBtn.addEventListener('click', () => rotate(1));
        if (nextBtn) nextBtn.addEventListener('click', () => rotate(-1));
        if (addBtn) addBtn.addEventListener('click', addNewTrack);

        document.body.addEventListener('click', (e) => {
          if (e.target.matches('.play-carousel-track')) {
            const audioUrl = e.target.dataset.audio;
            audioSystem.playTrack(audioUrl);
            
            // Scroll to visualizer
            const vizSection = document.getElementById('visualizer');
            if (vizSection) {
              gsap.to(window, {
                scrollTo: {
                  y: vizSection,
                  offsetY: 80
                },
                duration: 1.2,
                ease: 'power3.inOut'
              });
            }
          }
        });
      }

      function init() {
        loadMusic();
        render();
        setupEventListeners();
      }

      return { init };
    })();

    // 2D Visualizer Module
    const visualizer2D = (() => {
      const canvas = document.getElementById('viz');
      const ctx = canvas?.getContext('2d');

      function draw() {
        if (!canvas || !ctx) return;
        
        requestAnimationFrame(draw);
        
        ctx.fillStyle = 'rgba(16, 0, 43, 0.2)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (audioSystem.state.analyser) {
          audioSystem.state.analyser.getByteFrequencyData(audioSystem.state.dataArray);
          const bufferLength = audioSystem.state.dataArray.length;
          const barWidth = (canvas.width / bufferLength) * 2.5;
          let x = 0;

          for (let i = 0; i < bufferLength; i++) {
            const barHeight = audioSystem.state.dataArray[i];
            
            const r = barHeight + (25 * (i / bufferLength));
            const b = 255;

            ctx.fillStyle = `rgb(${r}, 0, ${b})`;
            ctx.fillRect(x, canvas.height - barHeight / 1.5, barWidth, barHeight / 1.5);

            x += barWidth + 1;
          }
        } else {
          ctx.fillStyle = '#00f3ff';
          ctx.fillRect(0, canvas.height / 2, canvas.width, 1);
        }
      }

      function init() {
        if (canvas && ctx) {
          draw();
        }
      }

      return { init };
    })();

    // 3D Background Module
    const background3D = (() => {
      const canvas = document.getElementById('bg');
      let scene, camera, renderer, plane, sun;
      let originalPositions;
      let time = 0;
      let animationId;

      function init() {
        if (!canvas || typeof THREE === 'undefined') return;

        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x10002b, 0.02);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5);

        renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));

        // Grid terrain
        const planeGeo = new THREE.PlaneGeometry(80, 80, 64, 64);
        const planeMat = new THREE.MeshBasicMaterial({
          color: 0xff0099,
          wireframe: true,
          transparent: true,
          opacity: 0.5
        });
        
        plane = new THREE.Mesh(planeGeo, planeMat);
        plane.rotation.x = -Math.PI / 2;
        plane.position.y = -5;
        scene.add(plane);

        // Retro sun
        const sunGeo = new THREE.CircleGeometry(15, 32);
        const sunMat = new THREE.MeshBasicMaterial({ color: 0xffcc00 });
        sun = new THREE.Mesh(sunGeo, sunMat);
        sun.position.set(0, 5, -50);
        scene.add(sun);

        // Sun glow
        const glowGeo = new THREE.CircleGeometry(17, 32);
        const glowMat = new THREE.MeshBasicMaterial({ 
          color: 0xff0099, 
          transparent: true, 
          opacity: 0.3 
        });
        const glow = new THREE.Mesh(glowGeo, glowMat);
        glow.position.set(0, 5, -51);
        scene.add(glow);

        originalPositions = plane.geometry.attributes.position.array.slice();

        setupMouseParallax();
        window.addEventListener('resize', utils.debounce(handleResize, 250));
        animate();
      }

      function setupMouseParallax() {
        window.addEventListener('mousemove', utils.throttle((e) => {
          const x = (e.clientX / window.innerWidth) - 0.5;
          const y = (e.clientY / window.innerHeight) - 0.5;
          camera.rotation.y = x * 0.1;
          camera.rotation.x = -y * 0.1;
        }, 16));
      }

      function animate() {
        animationId = requestAnimationFrame(animate);
        time += 0.05;

        // Audio reactivity
        if (audioSystem.state.analyser) {
          audioSystem.state.analyser.getByteFrequencyData(audioSystem.state.dataArray);
          
          let bass = 0;
          for (let k = 0; k < 10; k++) {
            bass += audioSystem.state.dataArray[k];
          }
          bass = bass / 10;
          
          const scale = 1 + (bass / 512);
          sun.scale.set(scale, scale, 1);
        }

        // Animate grid
        const positions = plane.geometry.attributes.position.array;
        
        for (let i = 0; i < positions.length; i += 3) {
          const x = originalPositions[i];
          const y = originalPositions[i + 1];
          
          let zHeight = Math.sin(x * 0.5 + time) * Math.cos(y * 0.3 + time) * 1.5;
          
          if (audioSystem.state.dataArray) {
            const freqIndex = Math.floor(Math.abs(x) + Math.abs(y) / 2) % 64;
            const audioValue = audioSystem.state.dataArray[freqIndex] || 0;
            zHeight += (audioValue / 50);
          }

          positions[i + 2] = zHeight;
        }
        
        plane.geometry.attributes.position.needsUpdate = true;
        renderer.render(scene, camera);
      }

      function handleResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function destroy() {
        cancelAnimationFrame(animationId);
        renderer.dispose();
      }

      return { init, destroy };
    })();

    // Scroll System Module - Simplified smooth scroll
    const scrollSystem = (() => {
      function init() {
        setupNavigation();
      }

      function setupNavigation() {
        const navLinks = document.querySelectorAll('.nav-link[href^="#"]');
        
        navLinks.forEach(anchor => {
          anchor.addEventListener('click', function(e) {
            e.preventDefault();
            const targetID = this.getAttribute('href');
            const targetElem = document.querySelector(targetID);
            
            if (targetElem) {
              gsap.to(window, {
                scrollTo: {
                  y: targetElem,
                  offsetY: 80
                },
                duration: 1.2,
                ease: 'power3.inOut'
              });
            }
          });
        });
      }

      return { init };
    })();

    // Application Initialization
    async function initApp() {
      try {
        await waitForLibraries();
        
        gsap.registerPlugin(ScrollTrigger, ScrollToPlugin);

        scrollSystem.init();
        audioSystem.setupEventListeners();
        carousel3D.init();
        visualizer2D.init();
        background3D.init();

        const yearEl = document.getElementById('year');
        if (yearEl) {
          yearEl.textContent = new Date().getFullYear();
        }
      } catch (error) {
        console.error('Error initializing application:', error);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
    
    })(); // Close IIFE
  </script>
</body>
</html>